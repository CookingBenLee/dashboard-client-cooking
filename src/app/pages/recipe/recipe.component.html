<mat-card class="cardWithShadow theme-card">
  <mat-card-header>
    <mat-card-title class="m-b-0">GESTION DES RECETTES</mat-card-title>
  </mat-card-header>
  <mat-card-content class="b-t-1">
    <p-tabView [(activeIndex)]="activeIndex">


      <!--Panel liste des purchases-->
      <p-tabPanel header="LISTE DES RECETTES">
        <div class="">
          <div class="card">
            <!--<h5>Purchase List</h5>-->

          <p-table
            #dt2
            [value]="recipes"
            responsiveLayout="scroll"
            [globalFilterFields]="['code','name','stock','cout','brut','quantite','detailCuisine','preparationIngredient','unit','categorie']">

            <ng-template pTemplate="header">
              <tr>
                <th pSortableColumn="youcooker" pColumnFilter="youcooker">YOU COOKER <p-sortIcon field="youcooker"></p-sortIcon></th>
                <th pSortableColumn="name" pColumnFilter="name">NOM <p-sortIcon field="name"></p-sortIcon></th>
                <th pSortableColumn="stock" pColumnFilter="stock">STOCK <p-sortIcon field="stock"></p-sortIcon></th>
                <th pSortableColumn="share" pColumnFilter="share">JE PARTAGE ? <p-sortIcon field="share"></p-sortIcon></th>
                <th style="justify-content: center; text-align: center;">ACTIONS</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-dishes>
              <tr class="cursor-pointer" (click)="showDishesDetail('top-right', dishes)">
                <!-- Colonne YOU COOKER -->
                <td style="width: 15%; min-width: 8rem;">
                  {{ dishes.owner ? 'MOI' : '' }}
                </td>

                <!-- Nom -->
                <td style="width: 25%; min-width: 8rem;">{{ dishes?.name }}</td>

                <!-- Stock -->
                <td style="width: 15%; min-width: 8rem;">
                  {{ dishes?.stock }} <span *ngIf="dishes.stock">Kg</span>
                </td>

                <!-- Je partage (cliquable avec dialogue de confirmation) -->
                <td style="width: 20%; min-width: 8rem; text-align: center; cursor: pointer;" 
                    (click)="onShareClick(dishes); $event.stopPropagation()"
                    [ngClass]="dishes.owner ? 'clickable-share' : 'disabled-share'">
                  <span [ngClass]="dishes.share ? 'text-green-600 font-semibold' : 'text-red-500 font-semibold'">
                    {{ dishes.share ? 'OUI' : 'NON' }}
                  </span>
                </td>

                <!-- Actions -->
                <td style="width: 30%; text-align: center;">
                  <button pButton pRipple type="button" (click)="show('top-right', dishes); $event.stopPropagation()" icon="pi pi-pencil"
                    class="p-button p-component p-button-text p-button-icon-only"></button>

                  <button pButton pRipple type="button" (click)="showPrepa(dishes); $event.stopPropagation()"
                    class="p-button p-component p-button-text p-button-icon-only">
                    <i class="pi pi-cog text-blue-500"></i>
                  </button>

                  <button pButton pRipple type="button" (click)="delete('top-right', dishes); $event.stopPropagation()" icon="pi pi-trash"
                    class="p-button p-component p-button-text p-button-icon-only"></button>
                </td>
              </tr>
            </ng-template>
          </p-table>

  <p-confirmDialog [style]="{ width: '400px' }" key="confirmShare" header="Confirmation"></p-confirmDialog>

            <p-paginator (onPageChange)="onPageChange($event)" [rows]="rows" [totalRecords]="totalRows"
              [rowsPerPageOptions]="[10, 25, 50]"></p-paginator>

          </div>

        </div>

      </p-tabPanel>


      <p-tabPanel (onFocus)="reset()" header="NOUVELLE RECETTE">
        <div class="dialog-container">
          <form class="grid newform" #f="ngForm" (ngSubmit)="save()">
            <div class="col-12 card p-fluid">
              <div class="grid entete">
                <div class="field col-6">
                  <label for="name">NOM DE LA RECETTE</label>
                  <input pInputText id="name" [(ngModel)]="name" name="name" type="text" placeholder="Nom de la recette"
                    required />
                </div>
                <!-- <div class="field col-4">
                  <label for="ratio">Pourcentage de perte</label>
                  <p-inputNumber mode="decimal" [minFractionDigits]="2" name="ratio" [suffix]="'%'" id="ratio"
                    [(ngModel)]="ratio" [showButtons]="true" [min]="0"></p-inputNumber>
                </div> -->
                <div class="field col-6">
                  <label for="principaleRecipe">EST-CE UNE RECETTE PRINCIPALE ?</label>
                  <p-dropdown [(ngModel)]="base" name="principaleRecipe" [options]="reciss" optionLabel="name"
                    placeholder="OUI ou NON"></p-dropdown>
                </div>
              </div>

              <h5 class="dialog-title">COMPOSITION DES INGREDIENTS LA RECETTE</h5>
             
                <button *ngIf="false" pButton label="AJOUTER UN INGREDIENT" type="button" [loading]="loading"
                  class="p-button-primary mt-2" (click)="showAddDetailDishesForm()"></button>
       

                  <div *ngIf="showAddDetailRecipe" class="cardnew mt-5">
                    <form class="p-fluid">
                      <div class="grid align-items-center">
                  
                        <!-- Produit dropdown -->
                        <div class="field col-3">
                          <label for="product{{detailRecipesProvisoire.length-1}}">INGRÉDIENT</label>
                          <p-dropdown [options]="products" optionLabel="name" [filter]="true" filterBy="name"
                            name="product{{detailRecipesProvisoire.length-1}}"
                            [(ngModel)]="detailRecipesProvisoire[detailRecipesProvisoire.length-1].ingredient"
                            (ngModelChange)="changeProduct(detailRecipesProvisoire[detailRecipesProvisoire.length-1].ingredient,detailRecipesProvisoire.length-1)">
                            <ng-template let-product pTemplate="item">
                              <div class="flex align-items-center gap-2">
                                <div>{{product.name}} ({{product?.category?.name}} / {{product?.conditioning?.name}})</div>
                              </div>
                            </ng-template>
                          </p-dropdown>
                        </div>
                  
                        <!-- Proportion input -->
                        <div class="field col-2">
                          <label for="quantity{{detailRecipesProvisoire.length-1}}">PROPORTION %</label>
                          <p-inputNumber mode="decimal" [minFractionDigits]="2"
                            name="quantity{{detailRecipesProvisoire.length-1}}"
                            [(ngModel)]="detailRecipesProvisoire[detailRecipesProvisoire.length-1].proportion"
                            (ngModelChange)="changeDetailQuantite(detailRecipesProvisoire[detailRecipesProvisoire.length-1],detailRecipesProvisoire.length-1,true)"
                            [showButtons]="true" [min]="0"></p-inputNumber>
                        </div>
                  
                        <!-- Preparation textarea -->
                        <div class="field col-6">
                          <label for="preparationIngredient">PRÉPARATION</label>
                          <textarea rows="2" cols="30" name="preparationIngredient" pInputTextarea
                            [(ngModel)]="detailRecipesProvisoire[detailRecipesProvisoire.length-1].preparationIngredient"
                            placeholder="Décrivez la préparation..."></textarea>
                        </div>
                  
                        <!-- Save Button (icône seule, centré verticalement) -->
                        <div class="field col-1 ">
                          <label for="preparationIngredient">AJOUTER</label>
                          <button class="flex align-items-center justify-content-center" pButton pRipple icon="pi pi-check"
                            [disabled]="detailRecipesProvisoire[detailRecipesProvisoire.length-1].proportion <= 0"
                            type="button" class="p-button-success"
                            (click)="firstSaveForDetail(detailRecipesProvisoire[detailRecipesProvisoire.length-1])">
                          </button>
                          
                        </div>
                  
                      </div>
                    </form>
                  </div>
                  


              

              <div class="info-table">
                <div class="info-header">
                  <div class="info-header-cell">INGREDIENT</div>
                  <div class="info-header-cell">PROPORTION</div>
                  <div class="info-header-cell">PREPARATION</div>
                  <div class="info-header-cell">ACTIONS</div>
                </div>

                <!-- Loop to display details -->
                <div *ngFor="let detail of detailRecipes; let i = index" class="info-row">
                  <div class="info-cell">{{ detail?.ingredient?.name }}</div>
                  <div class="info-cell">{{ detail.proportion }}%</div>
                  <div class="info-cell">{{ detail.preparationIngredient }}</div>
                  <div class="info-cell">
                    <button pButton pRipple type="button" icon="pi pi-trash" style="width: 15px; height: 15px; font-size: 12px;"
                      class="p-button p-component p-button-text p-button-icon-only"
                      (click)="confirmDeleteDetail(detail, i)"></button>
                  </div>
                </div>

                <!-- Total Row -->
                <div class="info-row total-row">
                  <div class="info-cell">TOTAL</div>
                  <div class="info-cell">{{ totalProportion }}%</div>
                  <div class="info-cell"></div> <!-- Empty cell for "Préparation" -->
                  <div class="info-cell"></div> <!-- Empty cell for "Actions" -->
                </div>
                
              </div>


              <p class="divider"></p>
              <div class="field  col-12">
                <div class="field">
                  <label htmlFor="detailCuisine">COMMENT PREPARER CETTE RECETTE ?</label>
                  <textarea rows="1" cols="30" name="detailCuisine" pInputTextarea
                    [(ngModel)]="detailCuisine"></textarea>
                </div>
              </div>
              <button pButton label="ENREGISTRER LA RECETTE" type="submit" [loading]="loading" class="p-button-vert"
                [disabled]="!f.valid"></button>
            </div>
          </form>
        </div>
      </p-tabPanel>
    </p-tabView>

    <p-toast position="top-center" key="tc"></p-toast>
    <p-toast key="product"></p-toast>

    <p-toast></p-toast>
    <p-confirmDialog [style]="{ width: '50vw' }" key="positionDialog" [position]="positionModalConfirm"
      rejectButtonStyleClass="p-button-outlined"></p-confirmDialog>
    <!--pour la modification d'une purchase-->
    <p-dialog *ngIf="isEditRecipeDialogVisible"
      header="Mise à jour de la Approvisionnement reference {{recipeClicked.code}}"
      [(visible)]="isEditRecipeDialogVisible" [style]="{ width: '50vw' }">
      <form #fUpdate="ngForm" (ngSubmit)="update()">
        <div class="card p-fluid">
          <h5>Mettre à jour</h5>



          <label id="erreur" *ngIf="isErrorEdit">{{erreurEdit}}</label>
          <label id="success" *ngIf="isSuccessEdit">{{sucessEdit}}</label>


          <button pButton type="submit" label="Modifier" class="p-button-orange" [loading]="loading"
            [disabled]="!fUpdate.valid"></button>

        </div>

      </form>

    </p-dialog>
    <!---->
  </mat-card-content>
</mat-card>
<p-dialog [(visible)]="productDialog" appendTo="body" [style]="{width: '850px'}" maskStyleClass="backdrop-blur-sm"
  header="Enregistrement du recette de base" class="p-fluid" [modal]="true" [closable]="false">
  <div class="grid">
    <form class=" newform col-12" #f="ngForm" (ngSubmit)="addProduct()">
      <div class="card p-fluid">
        <div class="grid">
          <div class="col-6">
            <div class="field">
              <label htmlFor="name">Nom</label>
              <input pInputText id="name" disabled="true" [(ngModel)]="productData.name" name="name" type="text"
                placeholder="Nom produit" required />
            </div>
          </div>
          <div class="col-6">
            <div class="field ">
              <label htmlFor="unit">Unité</label>
              <p-dropdown [options]="units" optionLabel="name" name="unit" [(ngModel)]="productData.unit"></p-dropdown>
            </div>
          </div>
          <div class="col-6">
            <div class="field ">
              <label htmlFor="category">Categorie</label>
              <p-dropdown [options]="categorys" optionLabel="name" name="category"
                [(ngModel)]="productData.category"></p-dropdown>
            </div>
          </div>
          <div class="col-6">
            <div class="field ">
              <label htmlFor="conditioning">Condition</label>
              <p-dropdown [options]="conditionings" optionLabel="name" name="conditioning"
                [(ngModel)]="productData.conditioning"></p-dropdown>
            </div>
          </div>
          <!-- <div class="col-6">
            <div class="field">
              <label htmlFor="lostpercentage">Pourcentage de perte</label>
              <p-inputNumber mode="decimal" [minFractionDigits]="2" name="lostpercentage" id="lostpercentage"
                [(ngModel)]="productData.lostpercentage" [showButtons]="true" [min]="0" [suffix]="'%'">
              </p-inputNumber>
            </div>
          </div> -->
        </div>

        <!-- <p>Description</p>
                  <textarea rows="5" cols="10" [(ngModel)]="productData.description" name="description" placeholder="Description"
                    pInputTextarea></textarea> -->

        <label id="erreur" *ngIf="isError">{{erreur}}</label>
        <label id="success" *ngIf="isSuccess">{{sucess}}</label>


        <button pButton label="Enregistrer" type="submit" class="p-button-orange mt-4"></button>

      </div>
    </form>
  </div>
</p-dialog>